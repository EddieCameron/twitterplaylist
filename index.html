<!DOCTYPE html>
<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>

    // Find the right method, call on correct element
    function launchIntoFullscreen(element) {
        if(element.requestFullscreen) {
            element.requestFullscreen();
        } else if(element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if(element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if(element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }

    $(function () {
        var socket = io();
        var allTweets = [];

        var lastVidStart = 0;
        var minTimePerVideo = 10000;

        Array.prototype.pickRandomElement = function () {
            var idx = Math.floor(Math.random() * this.length);
            return this.splice(idx, 1)[0];
        }

        function playNextVideo() {
            var tweetToPlay = allTweets.pickRandomElement();
            var sources = tweetToPlay.video_info.variants.map( v => "<source src=\"" + v.url + "\">" );

            var video = $('video');
            video.empty();
            video.append( sources );

            video.load();
            launchIntoFullscreen( video[0] );
        }

        $('form').submit(function(){
            var timeline = $('#timeline').val();
            if ( timeline.length == 0 ) {
                $('#error').text( "Empty timeline. Try again" );
            }
            else {
                $('#error').text( "Sending..." );
                socket.emit('timeline', timeline);
            }
            return false;
        });
            
        $('video').on('ended',function(){
            var now = new Date().getTime();
            if ( now - lastVidStart < minTimePerVideo )
                this.play();
            else {
                lastVidStart = now;
                playNextVideo();
            }
        });

        socket.on('mediaReceived', function(didSucceed, error, allMedia){
            console.log( "MediaReceived " + didSucceed );
            if ( didSucceed ) {
                allTweets = allMedia;
                $('#error').text( "Success" );
                playNextVideo();
            }
            else {
                $('#timeline').val("");
                $('#error').text( JSON.stringify(error) );
            }
        });

        socket.on('fetchProgress', function( progressPercent ) {
            $('#error').text( progressPercent + "%" );
        } );
    });
</script>
</head>
<body>
<form action="">
    <input id="timeline" autocomplete="off" /><button>Send</button>
</form>
<p id="error"></p>
<video preload="none" controls autoplay></video>
</body>
</html>
